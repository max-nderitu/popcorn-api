<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/scraper/providers/BaseProvider.js | popcorn-api</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="og:type" content="website"><meta property="og:url" content="https://popcorntime.sh"><meta property="og:site_name" content="popcorn-api"><meta property="og:title" content="popcorn-api"><meta property="og:image" content="https://avatars2.githubusercontent.com/u/7267937"><meta property="og:description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="og:author" content="https://twitter.com/popcorntimetv"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="popcorn-api"><meta property="twitter:description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="twitter:image" content="https://avatars2.githubusercontent.com/u/7267937"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/popcorn-official/popcorn-api"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#controllers">controllers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/ContentController.js~ContentController.html">ContentController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/ExportController.js~ExportController.html">ExportController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/IndexController.js~IndexController.html">IndexController</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#middleware">middleware</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/middleware/Cli.js~Cli.html">Cli</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-promptSchemas">promptSchemas</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-animemovie">models/animemovie</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/animemovie/AnimeMovieModel.js~AnimeMovieModel.html">AnimeMovieModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-animeshow">models/animeshow</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/animeshow/AnimeShowModel.js~AnimeShowModel.html">AnimeShowModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-content">models/content</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/content/ContentModel.js~ContentModel.html">ContentModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-contentSchema">contentSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Images">Images</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Rating">Rating</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://mongoosejs.com">Model</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-movie">models/movie</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/movie/MovieModel.js~MovieModel.html">MovieModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-movieSchema">movieSchema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-providerconfig">models/providerconfig</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/providerconfig/ProviderConfigModel.js~ProviderConfigModel.html">ProviderConfigModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-show">models/show</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/show/ShowModel.js~ShowModel.html">ShowModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-showSchema">showSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Episode">Episode</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper">scraper</a><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/eztv-api-pt">Eztv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/fanart.tv-api">Fanart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/horriblesubs-api">HorribleSubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/kat-api-pt">Kat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/nyaa-api-pt">Nyaa</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/omdb-api-pt">Omdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/vankasteelj/tmdbapi">Tmdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/vankasteelj/trakt.tv">Trakt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/edwellbrook/node-tvdb">Tvdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/yts-api-pt">Yts</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-configs">scraper/configs</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-eztvConfig">eztvConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-horribleSubsConfig">horribleSubsConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-katMovieConfig">katMovieConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaCommieConfig">nyaaCommieConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaFffConfig">nyaaFffConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaGgConfig">nyaaGgConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ytsConfig">ytsConfig</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-helpers">scraper/helpers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/AbstractHelper.js~AbstractHelper.html">AbstractHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/MovieHelper.js~MovieHelper.html">MovieHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/ShowHelper.js~ShowHelper.html">ShowHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/scraper/helpers/IHelper.js~IHelper.html">IHelper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-providers">scraper/providers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/BaseProvider.js~BaseProvider.html">BaseProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/BulkProvider.js~BulkProvider.html">BulkProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/MovieProvider.js~MovieProvider.html">MovieProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/ShowProvider.js~ShowProvider.html">ShowProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/YtsProvider.js~YtsProvider.html">YtsProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-providers-maps">scraper/providers/maps</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-movieMap">movieMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-showMap">showMap</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/scraper/providers/BaseProvider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// Import the necessary modules.
// @flow
import pMap from &apos;p-map&apos;
import pTimes from &apos;p-times&apos;
import { AbstractProvider } from &apos;pop-api-scraper&apos;

import type {
  MovieHelper,
  ShowHelper
} from &apos;../helpers&apos;

/**
 * Class for scraping content from various sources.
 * @implements {AbstractProvider}
 * @type {BaseProvider}
 */
export default class BaseProvider extends AbstractProvider {

  /**
   * Map of the available content types to scrape.
   * @type {Object}
   */
  static ContentTypes: Object = {
    Movie: &apos;movie&apos;,
    Show: &apos;show&apos;
  }

  /**
   * The api of the torrent provider.
   * @type {Object}
   */
  api: Object

  /**
   * The name of the torrent provider.
   * @type {string}
   */
  name: string

  /**
   * The helper class for adding movies.
   * @type {MovieHelper|ShowHelper}
   */
  helper: MovieHelper | ShowHelper

  /**
   * The type of content to scrape.
   * @type {string}
   */
  contentType: string

  /**
   * The max allowed concurrent web requests.
   * @type {number}
   */
  maxWebRequests: number

  /**
   * The query object for the api.
   * @type {Object}
   */
  query: Object

  /**
   * The regular expressions used to extract information about movies.
   * @type {Array&lt;Object&gt;}
   */
  regexps: Array&lt;Object&gt;

  /**
   * Gets information about a movie from Trakt.tv and insert the movie into the
   * MongoDB database.
   * @protected
   * @param {!Object} content - The content information.
   * @throws {Error} - &apos;movie&apos; is not a valid value for Types!
   * @returns {Promise&lt;Object, Error&gt;} - A movie object.
   */
  _getMovieContent(content: Object): Promise&lt;Object&gt; {
    const { episodes, slug } = content
    if (episodes &amp;&amp; episodes[0]) {
      delete episodes[0]
    }

    return this.helper.getTraktInfo(slug).then(res =&gt; {
      if (res &amp;&amp; res.imdb_id) {
        return this.helper.addEpisodes(res, episodes, slug)
      }
    })
  }

  /**
   * Gets information about a show from Trakt.tv and insert the show into the
   * MongoDB database.
   * @protected
   * @param {!Object} content - The show information.
   * @throws {Error} - &apos;show&apos; is not a valid value for Types!
   * @returns {Promise&lt;Object, Error&gt;} - A show object.
   */
  _getShowContent(content: Object): Promise&lt;Object&gt; {
    const { slugYear, torrents } = content
    return this.helper.getTraktInfo(slugYear).then(res =&gt; {
      if (res &amp;&amp; res.imdb_id) {
        return this.helper.addTorrents(res, torrents)
      }
    })
  }

  /**
   * Gets information about content from Trakt.tv and inserts the content into
   * the MongoDB database.
   * @protected
   * @param {!Object} content - The content information.
   * @throws {Error} - &apos;CONTENT_TYPE&apos; is not a valid value for Types!
   * @returns {Promise&lt;Object&gt;} - A content object.
   */
  getContent(content: Object): Promise&lt;Object&gt; {
    if (this.contentType === BaseProvider.ContentTypes.Movie) {
      return this._getShowContent(content)
    } else if (this.contentType === BaseProvider.ContentTypes.Show) {
      return this._getMovieContent(content)
    }

    const err = new Error(`&apos;${this.contentType}&apos; is not a valid value for ContentTypes!`)
    return Promise.reject(err)
  }

  /**
   * Extract content information based on a regex.
   * @abstract
   * @protected
   * @param {!Object} options - The options to extract content information.
   * @param {!Object} options.torrent - The torrent to extract the content
   * information.
   * @param {!Object} options.regex - The regex object to extract the content
   * information.
   * @param {?string} [lang] - The language of the torrent.
   * @throws {Error} - Using default method: &apos;extractContent&apos;
   * @returns {Object|undefined} - Information about the content from the
   * torrent.
   */
  extractContent({torrent, regex, lang}: Object): Object | void {
    throw new Error(&apos;Using default method: \&apos;extractContent\&apos;&apos;)
  }

  /**
   * Get content info from a given torrent.
   * @protected
   * @param {!Object} options - The options to get content info from a torrent.
   * @param {!Object} options.torrent - A torrent object to extract content
   * information from.
   * @param {!string} [optiosn.lang=en] - The language of the torrent.
   * @returns {Object|undefined} - Information about the content from the
   * torrent.
   */
  getContentData({torrent, lang = &apos;en&apos;}: Object): Object | void {
    const regex = this.regexps.find(
      r =&gt; r.regex.test(torrent.title) || r.regex.test(torrent.name)
    )

    if (regex) {
      return this.extractContent({
        torrent,
        regex,
        lang
      })
    }

    logger.warn(`${this.name}: Could not find data from torrent: &apos;${torrent.title}&apos;`)
  }

  /**
   * Attach the torrent object to the content.
   * @abstract
   * @protected
   * @param {!Object} options - The options to attach a torrent to the content.
   * @param {!Object} options.content - The content to attach a torrent to.
   * @param {!Object} options.torrent - The torrent object ot attach.
   * @param {!string} options.quality - The quality of the torrent.
   * @param {?number} options.season - The season number for the torrent.
   * @param {?number} options.episode - The episode number for the torrent.
   * @param {!string} [options.lang] - The language of the torrent.
   * @throws {Error} - Using default method: &apos;attachTorrent&apos;
   * @returns {Object} - The content with the newly attached torrent.
   */
  attachTorrent({
    content,
    torrent,
    quality,
    season,
    episode,
    lang
  }: Object): Object {
    throw new Error(&apos;Using default method: \&apos;attachTorrent\&apos;&apos;)
  }

  /**
   * Put all the found content from the torrents in an array.
   * @abstract
   * @protected
   * @param {!Object} options - The options to get the content.
   * @param {!Array&lt;Object&gt;} options.torrents - A list of torrents to extract
   * content information from.
   * @param {!string} [options.lang=en] - The language of the torrents.
   * @throws {Error} - Using default method: &apos;getAllContent&apos;
   * @returns {Promise&lt;Array&lt;Object&gt;, Error&gt;} - A list of object with
   * content information extracted from the torrents.
   */
  getAllContent({
    torrents,
    lang = &apos;en&apos;
  }: Object): Promise&lt;Array&lt;Object&gt;&gt; {
    throw new Error(&apos;Using default method: \&apos;getAllContent\&apos;&apos;)
  }

  /**
   * Get all the torrents of a given torrent provider.
   * @protected
   * @param {!number} totalPages - The total pages of the query.
   * @returns {Promise&lt;Array&lt;Object&gt;&gt;} - A list of all the queried torrents.
   */
  getAllTorrents(totalPages: number): Promise&lt;Array&lt;Object&gt;&gt; {
    let torrents = []
    return pTimes(totalPages, async page =&gt; {
      this.query.page = page + 1

      logger.info(`${this.name}: Started searching ${this.name} on page ${page + 1} out of ${totalPages}`)
      const res = await this.api.search(this.query)
      const data = res.results
        ? res.results // Kat &amp; ET
        : res.data
          ? res.data.movies // YTS
          : res.torrents
            ? res.torrents // Nyaa
            : []

      torrents = torrents.concat(data)
    }, {
      concurrency: 1
    }).then(() =&gt; {
      logger.info(`${this.name}: Found ${torrents.length} torrents.`)
      return torrents
    })
  }

  /**
   * Get the total pages to scrape for the provider query.
   * @protected
   * @returns {Promise&lt;number&gt;} - The number of total pages to scrape.
   */
  getTotalPages(): Promise&lt;number&gt; {
    return this.api.search(this.query).then(res =&gt; {
      if (res.data) { // Yts
        return Math.ceil(res.data.movie_count / 50)
      } else if (res.total_pages) { // Kat &amp; ET
        return res.total_pages
      }

      return Math.ceil(res.totalRecordCount / res.queryRecordCount) // Nyaa
    })
  }

  /**
   * Set the configuration to scrape with.
   * @protected
   * @param {!Object} config - The config to get content with.
   * @param {!string} config.name - The name of the config.
   * @param {!Object} config.api - The API module ot get the content with.
   * @param {!string} config.contentType - The type of content to scrape.
   * @param {!MongooseModel} config.Model - The model for the content to
   * scrape.
   * @param {!IHelper} config.Helper - The helper class to save the content to
   * the database.
   * @param {?Object} config.query - The query to get the content with for the
   * api.
   * @param {?Array&lt;Ojbect&gt;} config.regexps - The regular expressions used to
   * extract information from a torrent.
   * @returns {undefined}
   */
  setConfig({
    name,
    api,
    contentType,
    Model,
    Helper,
    query,
    regexps
  }: Object): void {
    this.name = name
    this.api = api
    this.contentType = contentType
    this.helper = new Helper({
      Model,
      name
    })
    this.query = query
    this.regexps = regexps
  }

  /**
   * Get the contents for a configuration.
   * @override
   * @param {!Object} config - The config to get content with.
   * @param {!string} config.name - The name of the config.
   * @param {!Object} config.api - The API module ot get the content with.
   * @param {!string} config.contentType - The type of content to scrape.
   * @param {!MongooseModel} config.Model - The model for the content to
   * scrape.
   * @param {!IHelper} config.Helper - The helper class to save the content to
   * the database.
   * @param {?Object} config.query - The query to get the content with for the
   * api.
   * @param {?Array&lt;Ojbect&gt;} config.regexps - The regular expressions used to
   * extract information from a torrent.
   * @returns {Promise&lt;Array&lt;Object&gt;|undefined, Error&gt;} - The results of a
   * configuration.
   */
  async scrapeConfig({
    name,
    api,
    contentType,
    Model,
    Helper,
    query,
    regexps
  }: Object): Promise&lt;Array&lt;Object&gt; | void&gt; {
    try {
      this.setConfig({name, api, contentType, Model, Helper, query, regexps})

      const totalPages = await this.getTotalPages()
      if (!totalPages) {
        return logger.error(
          `${this.name}: totalPages returned: &apos;${totalPages}&apos;`
        )
      }

      logger.info(`${this.name}: Total pages ${totalPages}`)

      const torrents = await this.getAllTorrents(totalPages)

      const { language } = this.query
      const allContent = await this.getAllContent({
        torrents,
        language
      })

      return await pMap(allContent, content =&gt; this.getContent(content), {
        concurrency: this.maxWebRequests
      })
    } catch (err) {
      logger.error(err)
    }
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
