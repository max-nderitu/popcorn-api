<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/scraper/helpers/MovieHelper.js | popcorn-api</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="og:type" content="website"><meta property="og:url" content="https://popcorntime.sh"><meta property="og:site_name" content="popcorn-api"><meta property="og:title" content="popcorn-api"><meta property="og:image" content="https://avatars2.githubusercontent.com/u/7267937"><meta property="og:description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="og:author" content="https://twitter.com/popcorntimetv"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="popcorn-api"><meta property="twitter:description" content="Popcorn Time API is developed to make it easier for anyone to create their own version of Popcorn Time."><meta property="twitter:image" content="https://avatars2.githubusercontent.com/u/7267937"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/popcorn-official/popcorn-api"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#controllers">controllers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/ContentController.js~ContentController.html">ContentController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/ExportController.js~ExportController.html">ExportController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/IndexController.js~IndexController.html">IndexController</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#middleware">middleware</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/middleware/Cli.js~Cli.html">Cli</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-promptSchemas">promptSchemas</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-animemovie">models/animemovie</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/animemovie/AnimeMovieModel.js~AnimeMovieModel.html">AnimeMovieModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-animeshow">models/animeshow</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/animeshow/AnimeShowModel.js~AnimeShowModel.html">AnimeShowModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-content">models/content</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/content/ContentModel.js~ContentModel.html">ContentModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-contentSchema">contentSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Images">Images</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Rating">Rating</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://mongoosejs.com">Model</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-movie">models/movie</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/movie/MovieModel.js~MovieModel.html">MovieModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-movieSchema">movieSchema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-providerconfig">models/providerconfig</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/providerconfig/ProviderConfigModel.js~ProviderConfigModel.html">ProviderConfigModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models-show">models/show</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/show/ShowModel.js~ShowModel.html">ShowModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-showSchema">showSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Episode">Episode</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper">scraper</a><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/eztv-api-pt">Eztv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/fanart.tv-api">Fanart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/horriblesubs-api">HorribleSubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/kat-api-pt">Kat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/nyaa-api-pt">Nyaa</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/omdb-api-pt">Omdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/vankasteelj/tmdbapi">Tmdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/vankasteelj/trakt.tv">Trakt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/edwellbrook/node-tvdb">Tvdb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/ChrisAlderson/yts-api-pt">Yts</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-configs">scraper/configs</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-eztvConfig">eztvConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-horribleSubsConfig">horribleSubsConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-katMovieConfig">katMovieConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaCommieConfig">nyaaCommieConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaFffConfig">nyaaFffConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nyaaGgConfig">nyaaGgConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ytsConfig">ytsConfig</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-helpers">scraper/helpers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/AbstractHelper.js~AbstractHelper.html">AbstractHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/MovieHelper.js~MovieHelper.html">MovieHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/helpers/ShowHelper.js~ShowHelper.html">ShowHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/scraper/helpers/IHelper.js~IHelper.html">IHelper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-providers">scraper/providers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/BaseProvider.js~BaseProvider.html">BaseProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/BulkProvider.js~BulkProvider.html">BulkProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/MovieProvider.js~MovieProvider.html">MovieProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/ShowProvider.js~ShowProvider.html">ShowProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scraper/providers/YtsProvider.js~YtsProvider.html">YtsProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scraper-providers-maps">scraper/providers/maps</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-movieMap">movieMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-showMap">showMap</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/scraper/helpers/MovieHelper.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// Import the necessary modules.
// @flow
import pMap from &apos;p-map&apos;

import AbstractHelper from &apos;./AbstractHelper&apos;
import {
  fanart,
  omdb,
  tmdb,
  trakt
} from &apos;../apiModules&apos;
import type {
  AnimeMovie,
  Movie
} from &apos;../../models&apos;

/**
 * Class for saving movies.
 * @extends {AbstractHelper}
 * @type {MovieHelper}
 */
export default class MovieHelper extends AbstractHelper {

  /**
   * Update the torrents for an existing movie.
   * @param {!AnimeMovie|Movie} movie - The new movie.
   * @param {!AnimeMovie|Movie} found - The existing movie.
   * @param {!string} language - The language of the torrent.
   * @param {!string} quality - The quality of the torrent.
   * @returns {AnimeMovie|Movie} - A movie with merged torrents.
   */
  _updateTorrent(
    movie: AnimeMovie | Movie,
    found: AnimeMovie | Movie,
    language: string,
    quality: string
  ): AnimeMovie | Movie {
    let update = false
    let movieTorrent = movie.torrents[language]

    const foundTorrent = found.torrents[language]

    if (foundTorrent &amp;&amp; movieTorrent) {
      const foundQuality = foundTorrent[quality]
      const movieQuality = movieTorrent[quality]

      if (foundQuality &amp;&amp; movieQuality) {
        if (foundQuality.seeds &gt; movieQuality.seeds ||
            foundQuality.url === movieQuality.url) {
          update = true
        }
      } else if (foundQuality &amp;&amp; !movieQuality) {
        update = true
      }
    } else if (foundTorrent &amp;&amp; !movieTorrent) {
      if (foundTorrent[quality]) {
        movieTorrent = {}
        update = true
      }
    }

    if (update) {
      movieTorrent[quality] = foundTorrent[quality]
    }

    return movie
  }

  /**
   * Update a given movie.
   * @param {!AnimeMovie|Movie} movie - The movie to update its torrent.
   * @returns {AnimeMovie|Movie} - A newly updated movie.
   */
  async _updateMovie(movie: AnimeMovie | Movie): AnimeMovie | Movie {
    try {
      let m = movie
      const found = await this.Model.findOne({
        imdb_id: m._id
      })

      if (found) {
        logger.info(`${this.name}: &apos;${found.title}&apos; is an existing movie.`)

        if (found.torrents) {
          Object.keys(found.torrents).map(language =&gt; {
            m = this._updateTorrent(m, found, language, &apos;720p&apos;)
            m = this._updateTorrent(m, found, language, &apos;1080p&apos;)
          })
        }

        return await this.Model.findOneAndUpdate({
          _id: m._id
        }, m, {
          upsert: true,
          new: true
        })
      }

      logger.info(`${this.name}: &apos;${m.title}&apos; is a new movie!`)
      return await new this.Model(m).save()
    } catch (err) {
      logger.error(err)
    }
  }

  /**
   * Adds torrents to a movie.
   * @param {!AnimeMovie|Movie} movie - The movie to add the torrents to.
   * @param {!Object} torrents - The torrents to add to the movie.
   * @returns {AnimeMovie|Movie} - A movie with torrents attached.
   */
  addTorrents(
    movie: AnimeMovie | Movie,
    torrents: Object
  ): AnimeMovie | Movie {
    return pMap(
      Object.keys(torrents),
      torrent =&gt; {
        movie.torrents[torrent] = torrents[torrent]
      }
    ).then(() =&gt; this._updateMovie(movie))
  }

  /**
   * Get movie images from TMDB.
   * @param {!string} tmdbId - The tmdb id of the movie you want the images
   * from.
   * @returns {Object} - Object with banner, fanart and poster images.
   */
  _getTmdbImages(tmdbId: string): Promise&lt;Object | Error&gt; {
    return tmdb.movie.images({
      movie_id: tmdbId
    }).then(i =&gt; {
      const baseUrl = &apos;http://image.tmdb.org/t/p/w500&apos;

      const tmdbPoster = i.posters.filter(
        poster =&gt; poster.iso_639_1 === &apos;en&apos; || poster.iso_639_1 === null
      )[0].file_path
      const tmdbBackdrop = i.backdrops.filter(
        backdrop =&gt; backdrop.iso_639_1 === &apos;en&apos; || backdrop.iso_639_1 === null
      )[0].file_path

      const { Holder } = AbstractHelper
      const images = {
        banner: tmdbPoster ? `${baseUrl}${tmdbPoster}` : Holder,
        fanart: tmdbBackdrop ? `${baseUrl}${tmdbBackdrop}` : Holder,
        poster: tmdbPoster ? `${baseUrl}${tmdbPoster}` : Holder
      }

      return this.checkImages(images)
    })
  }

  /**
   * Get movie images from OMDB.
   * @param {!string} imdbId - The imdb id of the movie you want the images
   * from.
   * @returns {Object} - Object with banner, fanart and poster images.
   */
  _getOmdbImages(imdbId: string): Promise&lt;Object | Error&gt; {
    return omdb.byId({
      imdb: imdbId,
      type: &apos;movie&apos;
    }).then(i =&gt; {
      const { Holder } = AbstractHelper
      const images = {
        banner: i.Poster ? i.Poster : Holder,
        fanart: i.Poster ? i.Poster : Holder,
        poster: i.Poster ? i.Poster : Holder
      }

      return this.checkImages(images)
    })
  }

  /**
   * Get movie images from Fanart.
   * @param {!number} tmdbId - The tvdb id of the movie you want the images
   * from.
   * @returns {Object} - Object with banner, fanart and poster images.
   */
  _getFanartImages(tmdbId: number): Promise&lt;Object | Error&gt; {
    return fanart.getMovieImages(tmdbId).then(i =&gt; {
      const { Holder } = AbstractHelper
      const images = {
        banner: i.moviebanner ? i.moviebanner[0].url : Holder,
        fanart: i.moviebackground
          ? i.moviebackground[0].url
          : i.hdmovieclearart
            ? i.hdmovieclearart[0].url
            : Holder,
        poster: i.movieposter ? i.movieposter[0].url : Holder
      }

      return this.checkImages(images)
    })
  }

  /**
   * Get movie images.
   * @override
   * @protected
   * @param {!number} tmdbId - The tmdb id of the movie you want the images
   * from.
   * @param {!string} imdbId - The imdb id of the movie you want the images
   * from.
   * @returns {Promise&lt;Object&gt;} - Object with banner, fanart and poster images.
   */
  getImages({tmdbId, imdbId}: Object): Promise&lt;Object&gt; {
    return this._getTmdbImages(imdbId)
      .catch(() =&gt; this._getOmdbImages(tmdbId))
      .catch(() =&gt; this._getFanartImages(tmdbId))
      .catch(() =&gt; AbstractHelper.DefaultImages)
  }

  /**
   * Get info from Trakt and make a new movie object.
   * @override
   * @param {!string} slug - The slug to query trakt.tv.
   * @returns {AnimeMovie|Movie} - A new movie.
   */
  async getTraktInfo(slug: string): Promise&lt;AnimeMovie | Movie | Error&gt; {
    try {
      const traktMovie = await trakt.movies.summary({
        id: slug,
        extended: &apos;full&apos;
      })
      const traktWatchers = await trakt.movies.watching({
        id: slug
      })

      if (traktMovie &amp;&amp; traktMovie.ids.imdb &amp;&amp; traktMovie.ids.tmdb) {
        const { imdb, slug, tmdb } = traktMovie.ids
        const images = this.getImages({
          imdbId: imdb,
          tmdbId: tmdb
        })

        return {
          imdb_id: imdb,
          title: traktMovie.title,
          year: traktMovie.year,
          slug,
          synopsis: traktMovie.overview,
          runtime: traktMovie.runtime,
          rating: {
            votes: traktMovie.votes,
            watching: traktWatchers ? traktWatchers.length : 0,
            percentage: Math.round(traktMovie.rating * 10)
          },
          images,
          genres: traktMovie.genres ? traktMovie.genres : [&apos;unknown&apos;],
          language: traktMovie.language,
          released: new Date(traktMovie.released).getTime() / 1000.0,
          trailer: traktMovie.trailer,
          certification: traktMovie.certification,
          torrents: {}
        }
      }
    } catch (err) {
      logger.error(`Trakt: Could not find any data on: ${err.path || err} with slug: &apos;${slug}&apos;`)
    }
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
